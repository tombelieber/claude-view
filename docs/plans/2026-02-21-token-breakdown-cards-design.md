# Token Breakdown Cards Design

**Date:** 2026-02-21
**Status:** Approved

## Problem

The analytics page shows "Tokens Used" as `input_tokens + output_tokens` (~10.2M), but the actual tokens processed including cache is ~7.0B. The `input_tokens` field from the Claude API represents only the non-cached slice (~0.08% of actual input). Cache read tokens (6.5B) are completely invisible. The numbers feel fake because they massively understate real usage.

## Solution

Replace the single "Tokens Used" MetricCard with a dedicated `TokenBreakdown` component: a hero card with stacked bar + 4 detail cards.

## Layout

```
┌───────────────────────────────────────────────────────────┐
│  TOTAL TOKENS PROCESSED                                    │
│  7.0B                                                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │████████████████████████████░░░░░▓▓▓▓▓▓▒▒            │  │
│  │  Cache Read 93.3%  │C.Write│Output│Input             │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                            │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │
│  │OUTPUT    │ │CACHE READ│ │CACHE WRITE│ │FRESH INPUT│    │
│  │ 4.8M    │ │ 6.5B     │ │  451M    │ │  5.4M    │     │
│  │ 0.07%   │ │ 93.3%    │ │  6.4%   │ │  0.08%   │     │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘     │
└───────────────────────────────────────────────────────────┘
```

## Color Palette

| Category | Light | Dark | Rationale |
|----------|-------|------|-----------|
| Output | blue-600 | blue-400 | Primary — the work Claude did |
| Cache Read | emerald-500 | emerald-400 | Green = cache savings |
| Cache Write | amber-500 | amber-400 | Warm = creation/writing |
| Fresh Input | gray-400 | gray-500 | Neutral — smallest slice |

## Data Flow Changes

### Backend (Rust)

1. Add `cache_read_tokens: i64` and `cache_creation_tokens: i64` to `AIGenerationStats` struct in `crates/db/src/queries/types.rs`
2. Add `COALESCE(SUM(cache_read_tokens), 0)` and `COALESCE(SUM(cache_creation_tokens), 0)` to the SQL query in `crates/db/src/queries/ai_generation.rs`

### API Response

New JSON fields: `cacheReadTokens`, `cacheCreationTokens`

### Frontend

1. Re-export updated TS types (generated by ts-rs)
2. New `TokenBreakdown` component in `src/components/TokenBreakdown.tsx`
3. New `StackedBar` micro-component (pure CSS, no chart library)
4. Update `AIGenerationStats.tsx` to use `TokenBreakdown` instead of "Tokens Used" MetricCard

## Component Structure

```
AIGenerationStats.tsx
├── [Files Edited] MetricCard (unchanged)
├── TokenBreakdown (NEW, full width)
│   ├── Hero: big number + StackedBar
│   └── 4x MetricCard: output, cache read, cache write, fresh input
├── Token Usage by Model (unchanged)
└── Top Projects (unchanged)
```

## Responsive

- Desktop (lg+): 4 detail cards in a row
- Tablet (md): 2x2 grid
- Mobile (sm): stacked, stacked bar stays horizontal
